<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®¶åº­è¨˜å¸³æœ¬ v6.1 (æº¯æºä¿®æ­£ç‰ˆ)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1041/1041888.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #e5e7eb; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-green { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .card-yellow { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .card-red { background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%); }
        .card-blue { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); }
        
        .app-container { max-width: 28rem; margin: 0 auto; background-color: #f9fafb; min-height: 100vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .safe-content { padding-top: calc(env(safe-area-inset-top) + 10px); padding-bottom: 120px; flex: 1; overflow-y: auto; }
        .sticky-header { position: sticky; top: 0; z-index: 40; background-color: rgba(249, 250, 251, 0.98); border-bottom: 1px solid #f3f4f6; padding-top: calc(env(safe-area-inset-top) + 10px); padding-bottom: 10px; padding-left: 1.25rem; padding-right: 1.25rem; }
        
        /* æ»‘å‹•åˆªé™¤ç›¸é—œ */
        .swipe-item-container { position: relative; overflow: hidden; border-radius: 0.75rem; margin-bottom: 0.75rem; }
        .swipe-actions { position: absolute; top: 0; bottom: 0; right: 0; display: flex; width: 140px; }
        .swipe-btn { flex: 1; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: pointer; }
        .btn-edit { background-color: #3B82F6; }
        .btn-del { background-color: #EF4444; }
        .swipe-content { position: relative; background: white; z-index: 10; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #f3f4f6; border-radius: 0.75rem; }
        .swiped .swipe-content { transform: translateX(-140px); }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes bounceShort { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); } }
        .animate-bounce-short { animation: bounceShort 0.3s ease-in-out; }

        .month-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .picker-btn { padding: 0.5rem; border-radius: 0.5rem; font-size: 0.875rem; text-align: center; font-weight: 500; transition: all 0.2s; border: 1px solid #f3f4f6; }
        .picker-btn.active { background-color: #10B981; color: white; border-color: #10B981; }

        /* å¿«é¸æ¨™ç±¤æ¨£å¼ */
        .tag-btn { font-size: 0.8rem; padding: 6px 12px; border-radius: 20px; border: 1px solid #e5e7eb; background-color: white; color: #4b5563; transition: all 0.2s; white-space: nowrap; font-weight: 500; }
        .tag-btn:active { background-color: #d1fae5; color: #059669; border-color: #10b981; transform: scale(0.95); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sticky-header flex flex-col space-y-3">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-wallet text-green-600"></i><span id="pageTitle">ç¸½è¦½</span></h1>
                <div class="text-sm text-gray-400 font-mono" id="statusIndicator">é€£ç·šä¸­...</div>
            </div>
            
            <div id="monthNav" class="flex items-center justify-between bg-white rounded-xl p-1 shadow-sm border border-gray-100">
                <button onclick="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 active:scale-95"><i class="fas fa-chevron-left"></i></button>
                <button onclick="openDatePicker('month')" id="currentMonthLabel" class="text-lg font-bold text-gray-800 font-mono tracking-wider px-4 py-1 rounded-lg active:bg-gray-100">Loading</button>
                <button onclick="changeMonth(1)" class="w-10 h-10 flex items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 active:scale-95"><i class="fas fa-chevron-right"></i></button>
            </div>
            
            <div id="yearNav" class="hidden flex items-center justify-between bg-indigo-50 rounded-xl p-1 shadow-inner border border-indigo-100">
                <button onclick="changeYear(-1)" class="w-10 h-10 flex items-center justify-center rounded-lg text-indigo-500 hover:bg-white active:scale-95"><i class="fas fa-chevron-left"></i></button>
                <button onclick="openDatePicker('year')" id="currentYearLabel" class="text-lg font-bold text-indigo-800 font-mono tracking-wider px-4 py-1 rounded-lg active:bg-white/50">Loading</button>
                <button onclick="changeYear(1)" class="w-10 h-10 flex items-center justify-center rounded-lg text-indigo-500 hover:bg-white active:scale-95"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="mainContainer" class="safe-content px-5 no-scrollbar">
            
            <div id="view-home" class="space-y-6 fade-in">
                <div id="statusCard" class="card-green rounded-3xl p-6 text-white shadow-xl relative overflow-hidden transition-all duration-500">
                    <div class="relative z-10">
                        <p class="text-sm opacity-90 mb-1 font-medium">æœ¬æœˆå‰©é¤˜é ç®—</p>
                        <h2 class="text-5xl font-bold tracking-wider mb-4" id="balanceDisplay">---</h2>
                        <div class="flex justify-between items-center bg-black/10 rounded-xl p-3 backdrop-blur-sm">
                            <div class="text-center w-1/2 border-r border-white/20"><div class="text-xs opacity-75">æ”¶å…¥</div><div class="text-lg font-bold" id="incomeDisplay">0</div></div>
                            <div class="text-center w-1/2"><div class="text-xs opacity-75">æ”¯å‡º</div><div class="text-lg font-bold" id="expenseDisplay">0</div></div>
                        </div>
                    </div>
                    <div class="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 rounded-full bg-white opacity-10 blur-2xl"></div>
                </div>

                <div id="debtCard" class="card-blue rounded-3xl p-6 text-white shadow-xl relative overflow-hidden transition-all duration-500">
                    <div class="relative z-10">
                        <p class="text-sm opacity-90 mb-1 font-medium">æœ¬æœˆå·²åˆ·é‡‘é¡</p>
                        <h2 class="text-5xl font-bold tracking-wider mb-4" id="currentCreditBigDisplay">---</h2>
                        <div class="flex justify-between items-center bg-black/10 rounded-xl p-3 backdrop-blur-sm mb-4">
                            <div class="text-center w-1/2 border-r border-white/20"><div class="text-xs opacity-75">æœˆé¡åº¦</div><div class="text-lg font-bold" id="monthlyLimitDisplay">0</div></div>
                            <div class="text-center w-1/2"><div class="text-xs opacity-75">æœ¬æœˆå‰©é¤˜</div><div class="text-lg font-bold" id="monthlyRemainingDisplay">0</div></div>
                        </div>
                        <div class="pt-2 border-t border-white/20">
                            <div class="flex justify-between items-end mb-1"><span class="text-xs opacity-80">ç¸½é¡åº¦ä½”ç”¨ (å«æœªä¾†)</span><span class="text-sm font-bold" id="totalDebtLabel">0%</span></div>
                            <div class="w-full bg-black/20 rounded-full h-2 overflow-hidden flex"><div id="currentCreditBar" class="bg-white h-2 opacity-90" style="width: 0%"></div><div id="futureDebtBar" class="bg-white h-2 opacity-50" style="width: 0%"></div></div>
                            <div class="flex justify-between text-[10px] opacity-70 mt-1"><span>æœ¬æœˆ</span><span>æœªä¾†åˆ†æœŸ <span id="futureDebtDisplay">$0</span></span></div>
                        </div>
                    </div>
                    <div class="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 rounded-full bg-white opacity-10 blur-2xl"></div>
                </div>

                <div class="mt-2">
                    <h3 class="text-sm font-bold text-gray-500 mb-3 px-1 flex items-center">
                        <i class="fas fa-history mr-2"></i>æœ€è¿‘æ–°å¢ç´€éŒ„
                    </h3>
                    <div id="recentTransactionList" class="space-y-3 pb-6">
                        <div class="text-center text-gray-400 text-xs py-4">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>

            <div id="view-history" class="hidden space-y-4 fade-in">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-0 z-20">
                    <div class="flex space-x-2 mb-3">
                        <select id="categoryFilter" onchange="renderHistory()" class="flex-1 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg p-2.5 outline-none"><option value="all">ğŸ“ å…¨éƒ¨é¡åˆ¥</option></select>
                        <div class="bg-green-50 text-green-700 rounded-lg px-3 py-2 flex flex-col items-end justify-center min-w-[100px]"><span class="text-[10px] text-green-500">æœ¬æœˆå°è¨ˆ</span><span class="text-sm font-bold" id="filterTotalDisplay">$0</span></div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-1/3 h-28 relative"><canvas id="monthPieChart"></canvas><div id="monthPieEmpty" class="hidden absolute inset-0 flex items-center justify-center text-gray-400 text-xs">ç„¡è³‡æ–™</div></div>
                        <div class="w-2/3 pl-3 h-28 overflow-y-auto no-scrollbar"><div id="categoryDetailList" class="space-y-1"></div></div>
                    </div>
                </div>
                <div class="text-xs text-gray-400 text-center flex items-center justify-center gap-1"><i class="fas fa-hand-pointer"></i> é»æ“Šå³å´æŒ‰éˆ•æˆ–å·¦æ»‘é …ç›®ä»¥ç·¨è¼¯</div>
                <div id="transactionList" class="space-y-3 pb-20"></div>
            </div>

            <div id="view-analysis" class="hidden space-y-5 fade-in">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-gray-500">æœˆæ”¯å‡ºæ¯”è¼ƒ (MoM)</h3><span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-400">æœ¬æœˆ vs ä¸Šæœˆ</span></div>
                    <div class="flex items-end justify-between">
                        <div><div class="text-3xl font-bold text-gray-800" id="momDiffDisplay">---</div><div class="text-xs text-gray-400 mt-1" id="momTextDisplay">è¨ˆç®—ä¸­...</div></div>
                        <div class="text-right"><div class="text-xs text-gray-400">ä¸Šæœˆæ”¯å‡º</div><div class="font-bold text-gray-600" id="lastMonthTotalDisplay">$0</div></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><div class="text-xs text-gray-400 mb-1">æœ¬å¹´åº¦ç´¯è¨ˆ</div><div id="yearTotalVal" class="text-lg font-bold text-gray-800">---</div></div>
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><div class="text-xs text-gray-400 mb-1">å¹´åº¦æœˆå‡</div><div id="avgYearVal" class="text-lg font-bold text-blue-600">---</div></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700"><i class="fas fa-chart-line text-green-500 mr-2"></i>å¹´åº¦æ¶ˆè²»èµ°å‹¢</h3></div>
                    <div class="h-56 w-full"><canvas id="trendChart"></canvas></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700"><i class="fas fa-chart-pie text-orange-500 mr-2"></i>å…¨å¹´åº¦æ¶ˆè²»çµæ§‹</h3></div>
                    <div class="flex items-center flex-col">
                        <div class="h-48 w-full relative mb-4"><canvas id="yearPieChart"></canvas></div>
                        <div class="flex w-full space-x-2 mb-2 bg-gray-50 p-2 rounded-xl">
                            <select id="annualCatFilter" onchange="renderAnnualDetails()" class="flex-1 text-xs bg-white border border-gray-200 rounded-lg p-2 outline-none"><option value="all">ğŸ“Š å…¨éƒ¨é …ç›® (ç¸½è¨ˆ)</option></select>
                            <button onclick="toggleAnnualSort()" class="bg-white border border-gray-200 px-3 py-1 rounded-lg text-xs font-bold text-gray-600 hover:text-green-600 flex items-center"><i class="fas fa-sort mr-1"></i> <span id="sortLabel">é‡‘é¡</span></button>
                        </div>
                        <div id="annualDetailsList" class="w-full space-y-1 max-h-96 overflow-y-auto no-scrollbar"></div>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="hidden space-y-6 fade-in">
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                    <div class="p-5 border-b border-gray-50">
                        <label class="text-sm text-gray-500 block mb-2 font-bold">ä¿¡ç”¨å¡è¨­å®š</label>
                        <div class="space-y-4">
                            <div class="relative"><span class="text-xs text-gray-400 absolute left-3 top-[-8px] bg-white px-1">æœˆåˆ·å¡é¡åº¦</span><input type="number" id="monthlyLimitInput" class="w-full bg-gray-50 rounded-xl py-3 pl-3 text-lg font-bold text-gray-800 outline-none pl-8" placeholder="50000" onchange="saveSettings()"><span class="absolute left-3 top-3 text-gray-400">$</span></div>
                            <div class="relative"><span class="text-xs text-gray-400 absolute left-3 top-[-8px] bg-white px-1">ç¸½ä¿¡ç”¨é¡åº¦</span><input type="number" id="creditLimitInput" class="w-full bg-gray-50 rounded-xl py-3 pl-3 text-lg font-bold text-gray-800 outline-none pl-8" placeholder="200000" onchange="saveSettings()"><span class="absolute left-3 top-3 text-gray-400">$</span></div>
                        </div>
                    </div>
                </div>
                <button onclick="exportToCSV()" class="w-full bg-white hover:bg-gray-50 text-gray-600 font-bold rounded-2xl py-4 shadow-sm flex items-center justify-center border border-gray-200 transition active:scale-95"><i class="fas fa-file-csv mr-2 text-blue-500 text-xl"></i> åŒ¯å‡º CSV å‚™ä»½</button>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-2 flex justify-between items-center z-50 pb-[env(safe-area-inset-bottom)] shadow-[0_-5px_20px_rgba(0,0,0,0.03)] max-w-[28rem] mx-auto">
            <button onclick="switchTab('home')" class="nav-item flex flex-col items-center justify-center w-14 h-12 text-green-600" data-target="home"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">ç¸½è¦½</span></button>
            <button onclick="switchTab('history')" class="nav-item flex flex-col items-center justify-center w-14 h-12 text-gray-400 hover:text-gray-600 transition" data-target="history"><i class="fas fa-list text-xl mb-1"></i><span class="text-[10px] font-bold">æ˜ç´°</span></button>
            <button onclick="openAddModal()" class="w-14 h-14 bg-gray-900 text-white rounded-full shadow-lg shadow-green-900/30 flex items-center justify-center text-2xl transform -translate-y-5 active:scale-95 transition border-4 border-gray-100"><i class="fas fa-plus"></i></button>
            <button onclick="switchTab('analysis')" class="nav-item flex flex-col items-center justify-center w-14 h-12 text-gray-400 hover:text-gray-600 transition" data-target="analysis"><i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-bold">åˆ†æ</span></button>
            <button onclick="switchTab('settings')" class="nav-item flex flex-col items-center justify-center w-14 h-12 text-gray-400 hover:text-gray-600 transition" data-target="settings"><i class="fas fa-cog text-xl mb-1"></i><span class="text-[10px] font-bold">è¨­å®š</span></button>
        </nav>

        <div id="addModal" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-end justify-center sm:items-center backdrop-blur-sm transition-opacity">
            <div class="bg-white w-full max-w-md p-6 rounded-t-3xl sm:rounded-2xl animate-slide-in max-h-[90vh] overflow-y-auto pb-[calc(env(safe-area-inset-bottom)+20px)]">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-800">è¨˜ä¸€ç­†</h3><button onclick="closeAddModal()" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-500"><i class="fas fa-times"></i></button></div>
                <div class="space-y-4">
                    <div class="relative"><span class="absolute left-0 top-3 text-xl text-gray-400">$</span><input type="number" id="amountInput" class="w-full pl-6 text-4xl font-bold border-b border-gray-200 py-2 outline-none text-gray-800" placeholder="0" inputmode="decimal"></div>
                    <div class="flex space-x-3"><input type="date" id="dateInput" class="bg-gray-50 border-none rounded-xl px-4 py-3 text-gray-700 font-bold outline-none w-1/2 text-sm"><select id="typeInput" onchange="updateCategories()" class="bg-gray-50 border-none rounded-xl px-4 py-3 text-gray-700 font-bold outline-none w-1/2 text-sm"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>
                    <select id="combinedCategoryInput" onchange="renderQuickTags()" class="w-full bg-gray-50 border-none rounded-xl p-4 font-bold text-gray-700 outline-none text-base"></select>
                    
                    <div id="expenseOnlyFields" class="space-y-4">
                        <select id="paymentInput" onchange="toggleInstallment()" class="w-full bg-gray-50 border-none rounded-xl p-4 text-gray-700 outline-none text-base"><option value="cash">ç¾é‡‘</option><option value="credit">ä¿¡ç”¨å¡</option><option value="linepay">è¡Œå‹•æ”¯ä»˜</option><option value="transfer">è½‰å¸³</option></select>
                        <div id="installmentBlock" class="hidden bg-indigo-50 p-3 rounded-xl">
                            <div class="flex justify-between text-xs text-indigo-500 font-bold mb-1"><span>åˆ†æœŸä»˜æ¬¾</span><span>è‡ªå‹•è¨ˆå…¥æœªä¾†(æ¬¡æœŸèµ·ç‚ºæ¯æœˆ1è™Ÿ)</span></div>
                            <div class="flex space-x-2">
                                <select id="installmentSelect" onchange="handleInstallmentChange()" class="flex-1 bg-white border-none rounded-lg p-2 text-sm text-gray-700 outline-none">
                                    <option value="1">ä¸€æ¬¡ä»˜æ¸…</option>
                                    <option value="3">3æœŸ</option>
                                    <option value="6">6æœŸ</option>
                                    <option value="12">12æœŸ</option>
                                    <option value="custom">è‡ªè¨‚æœŸæ•¸...</option>
                                </select>
                                <input type="number" id="installmentCustomInput" class="hidden w-20 bg-white border-none rounded-lg p-2 text-sm text-gray-700 outline-none" placeholder="æœŸæ•¸" min="1">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div id="quickTagContainer" class="flex flex-wrap gap-2 px-1 min-h-[0.5rem]"></div>
                        <input type="text" id="noteInput" class="w-full border border-gray-200 rounded-xl p-3 text-base outline-none focus:border-green-500" placeholder="å‚™è¨»...">
                    </div>
                    
                    <button id="submitBtn" onclick="submitForm()" class="w-full bg-gray-900 text-white font-bold rounded-xl py-4 shadow-lg active:scale-95 transition mt-2 text-lg">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div id="datePickerModal" class="hidden fixed inset-0 bg-black/60 z-[80] flex items-center justify-center backdrop-blur-sm transition-opacity"><div class="bg-white w-full max-w-xs p-5 rounded-2xl animate-slide-in"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">é¸æ“‡æ—¥æœŸ</h3><button onclick="document.getElementById('datePickerModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="flex items-center justify-between bg-gray-100 rounded-lg p-1 mb-4"><button onclick="selectPickerYear(-1)" class="w-8 h-8 flex items-center justify-center rounded text-gray-500 hover:bg-white"><i class="fas fa-chevron-left"></i></button><span id="pickerYearDisplay" class="font-bold text-gray-700 text-lg">2026</span><button onclick="selectPickerYear(1)" class="w-8 h-8 flex items-center justify-center rounded text-gray-500 hover:bg-white"><i class="fas fa-chevron-right"></i></button></div><div id="pickerMonthGrid" class="month-grid mb-4"></div><button onclick="confirmDatePick()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl active:scale-95 transition">ç¢ºèªé¸æ“‡</button></div></div>

        <div id="successToast" class="hidden fixed inset-0 z-[90] flex items-center justify-center pointer-events-none">
            <div class="bg-black/80 text-white px-6 py-4 rounded-2xl shadow-2xl flex flex-col items-center animate-bounce-short backdrop-blur-md">
                <div class="w-12 h-12 rounded-full bg-green-500 flex items-center justify-center mb-2 shadow-lg shadow-green-500/50">
                    <i class="fas fa-check text-2xl"></i>
                </div>
                <span class="font-bold text-lg tracking-widest">è¨˜å¸³æˆåŠŸ</span>
            </div>
        </div>
    </div>

    <script>
        const categories = { 
            'é£²é£Ÿ': ['å¤–é£Ÿ', 'é£²æ–™', 'ç”Ÿé®®é£Ÿæ', 'é›¶é£Ÿ/é»å¿ƒ'], 
            'å±…ä½': ['æˆ¿ç§Ÿ/ç®¡ç†è²»', 'æ°´é›»ç“¦æ–¯', 'æ‰‹æ©Ÿç¶²è·¯', 'ç¶­ä¿®/ä¿®ç¹•'], 
            'äº¤é€š': ['å¤§çœ¾é‹è¼¸', 'è¨ˆç¨‹è»Š', 'åŠ æ²¹', 'åœè»Š/éè·¯è²»', 'ä¿é¤Šç¶­ä¿®'], 
            'è³¼ç‰©': ['æ—¥å¸¸ç”¨å“', 'è¡£ç‰©é£¾å“', 'ç¾å¦ä¿é¤Š', 'å®¶é›»', '3Cç”¢å“', 'é›œè²¨'], 
            'å¨›æ¨‚': ['ä¼‘é–’å¨›æ¨‚', 'è¨‚é–±æœå‹™', 'æ—…éŠ/ä½å®¿', 'éŠæˆ²'], 
            'é†«ç™‚': ['çœ‹è¨º/æ›è™Ÿ', 'è—¥å“/è€—æ', 'ä¿å¥é£Ÿå“'], 
            'ä¿éšª': ['é†«ç™‚/å£½éšª', 'å„²è“„éšª', 'è»Šéšª/ç”¢éšª', 'å…¶ä»–ä¿éšª'], 
            'å­å¥³': ['å­¸è²»/å®‰è¦ª', 'å°¿å¸ƒ', 'å¥¶ç²‰', 'è¡£ç‰©/ç©å…·', 'å…¶ä»–æ¯å¬°ç”¨å“'], 
            'æŠ•è³‡': ['è‚¡ç¥¨', 'åŸºé‡‘', 'å¤–åŒ¯', 'è™›æ“¬è²¨å¹£'], 
            'ç¤¾äº¤': ['å­è¦ªè²»', 'é€ç¦®', 'ç´…åŒ…', 'å¥ å„€'], 
            'å…¶ä»–': ['ç¨…é‡‘', 'ç½°å–®', 'ææ¬¾', 'é›œæ”¯'] 
        };

        const categoryTags = {
            'å¤–é£Ÿ': ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'å®µå¤œ'],
            'é£²æ–™': ['æ‰‹æ–', 'å’–å•¡'],
            'å¤§çœ¾é‹è¼¸': ['æ·é‹', 'å…¬è»Š', 'ç«è»Š', 'é«˜éµ'],
            'åŠ æ²¹': ['æ©Ÿè»Š', 'æ±½è»Š'],
            'ä¿é¤Šç¶­ä¿®': ['æ´—è»Š'],
            'è¡£ç‰©é£¾å“': ['è¡£ç‰©', 'é‹å­', 'åŒ…åŒ…'],
            'ç¾å¦ä¿é¤Š': ['ç¾å¦', 'ä¿é¤Š', 'ç¾å®¹ç¾é«®'],
            '3Cç”¢å“': ['æ‰‹æ©Ÿ', 'é›»è…¦'],
            'æˆ¿ç§Ÿ/ç®¡ç†è²»': ['æˆ¿ç§Ÿ', 'ç®¡ç†è²»'],
            'æ‰‹æ©Ÿç¶²è·¯': ['æ‰‹æ©Ÿæœˆç§Ÿ', 'ç¶²è·¯æœˆç§Ÿ'],
            'è¨‚é–±æœå‹™': ['YT', 'NETFLIX', 'ICLOUD', 'GOOGLEé›²ç«¯'],
            'æ—…éŠ/ä½å®¿': ['æ©Ÿç¥¨', 'ä½å®¿'],
            'å…¶ä»–æ¯å¬°ç”¨å“': ['æ¿•ç´™å·¾', 'å¯¶å¯¶é›¶é£Ÿ']
        };

        const firebaseConfig = { apiKey: "AIzaSyB0Q0uKPDyKZHD5wnSFnf-hlKqC0aD2oTs", authDomain: "ourfamilymoney-57b36.firebaseapp.com", projectId: "ourfamilymoney-57b36", storageBucket: "ourfamilymoney-57b36.firebasestorage.app", messagingSenderId: "94253141932", appId: "1:94253141932:web:d25f33fc539b171d667409" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let appSettings = JSON.parse(localStorage.getItem('appSettings')) || { creditLimit: 200000, monthlyLimit: 50000 };
        if(!appSettings.monthlyLimit) appSettings.monthlyLimit = 50000;
        let transactions = [], allAnnualData = [], currentViewDate = new Date(), currentViewYear = new Date().getFullYear();
        let unsubscribe = null, unsubscribeRecent = null, monthPieChart = null, trendChart = null, yearPieChart = null;
        let pickerTempDate = new Date(), pickerMode = 'month', annualSortMode = 'amount';
        
        let editingId = null;
        let editingGroupId = null;

        document.getElementById('creditLimitInput').value = appSettings.creditLimit;
        document.getElementById('monthlyLimitInput').value = appSettings.monthlyLimit;
        
        refreshCategoryUI();
        loadData();
        loadRecentTransactions();

        function refreshCategoryUI() {
            initCategoryFilter(); 
            updateCategories();
            renderHistory();
        }

        function switchTab(tabId) {
            ['home', 'history', 'analysis', 'settings'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                const btn = document.querySelector(`button[data-target="${id}"]`);
                if(btn) { btn.classList.remove('text-green-600'); btn.classList.add('text-gray-400'); }
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            const targetBtn = document.querySelector(`button[data-target="${tabId}"]`);
            if(targetBtn) { targetBtn.classList.add('text-green-600'); targetBtn.classList.remove('text-gray-400'); }
            document.getElementById('pageTitle').innerText = { 'home':'ç¸½è¦½', 'history':'æ˜ç´°', 'analysis':'åˆ†æ', 'settings':'è¨­å®š' }[tabId];
            if (tabId === 'settings') { 
                document.getElementById('monthNav').classList.add('hidden'); 
                document.getElementById('yearNav').classList.add('hidden'); 
            } else if (tabId === 'analysis') { 
                document.getElementById('monthNav').classList.add('hidden'); 
                document.getElementById('yearNav').classList.remove('hidden'); 
                loadAnnualData(); calculateMoM(); 
            } else { 
                document.getElementById('monthNav').classList.remove('hidden'); 
                document.getElementById('yearNav').classList.add('hidden'); 
                if(tabId==='history') renderHistory(); 
            }
        }

        function changeMonth(off) { currentViewDate.setMonth(currentViewDate.getMonth()+off); loadData(); }
        function changeYear(off) { currentViewYear += off; loadAnnualData(); }
        
        function openDatePicker(mode) { pickerMode = mode; pickerTempDate = (mode === 'year') ? new Date(currentViewYear, 0, 1) : new Date(currentViewDate); document.getElementById('datePickerModal').classList.remove('hidden'); renderDatePickerUI(); }
        function renderDatePickerUI() {
            document.getElementById('pickerYearDisplay').innerText = pickerTempDate.getFullYear();
            const grid = document.getElementById('pickerMonthGrid'); grid.innerHTML = '';
            if (pickerMode === 'month') { grid.classList.remove('hidden'); for (let i = 0; i < 12; i++) { const btn = document.createElement('div'); btn.className = `picker-btn cursor-pointer ${pickerTempDate.getMonth() === i ? 'active' : ''}`; btn.innerText = `${i + 1}æœˆ`; btn.onclick = () => selectPickerMonth(i); grid.appendChild(btn); } } else grid.classList.add('hidden');
        }
        function selectPickerYear(off) { pickerTempDate.setFullYear(pickerTempDate.getFullYear() + off); renderDatePickerUI(); }
        function selectPickerMonth(m) { pickerTempDate.setMonth(m); renderDatePickerUI(); }
        function confirmDatePick() { document.getElementById('datePickerModal').classList.add('hidden'); if (pickerMode === 'month') { currentViewDate = new Date(pickerTempDate); loadData(); } else { currentViewYear = pickerTempDate.getFullYear(); loadAnnualData(); } }

        function loadData() {
            if (unsubscribe) unsubscribe();
            const y = currentViewDate.getFullYear(), m = currentViewDate.getMonth();
            document.getElementById('currentMonthLabel').innerText = `${y}å¹´ ${m + 1}æœˆ`;
            const start = new Date(y, m, 1), next = new Date(y, m + 1, 1);
            document.getElementById('statusIndicator').innerText = "æ›´æ–°ä¸­...";
            unsubscribe = db.collection("transactions").where("date", ">=", start.toISOString()).where("date", "<", next.toISOString()).orderBy("date", "desc").onSnapshot(snap => { transactions = []; snap.forEach(d => transactions.push({ id: d.id, ...d.data() })); updateHomeUI(); renderHistory(); document.getElementById('statusIndicator').innerText = "ğŸŸ¢ é€£ç·š"; if(!document.getElementById('view-analysis').classList.contains('hidden')) calculateMoM(); }, err => { console.error(err); document.getElementById('statusIndicator').innerText = "ğŸ”´ æ–·ç·š"; });
            monitorFutureDebt(next.toISOString());
        }

        function loadRecentTransactions() {
            if (unsubscribeRecent) unsubscribeRecent();
            unsubscribeRecent = db.collection("transactions").orderBy("createdAt", "desc").limit(5).onSnapshot(snap => {
                const list = document.getElementById('recentTransactionList');
                if(snap.empty) { list.innerHTML = '<div class="text-center text-gray-300 text-xs py-2">å°šç„¡ç´€éŒ„</div>'; return; }
                list.innerHTML = '';
                snap.forEach(doc => {
                    const t = doc.data(); const d = new Date(t.date); const isExp = t.type === 'expense';
                    list.innerHTML += `<div class="bg-white p-3 rounded-xl flex items-center justify-between shadow-sm border border-gray-100"><div class="flex items-center"><div class="w-8 h-8 rounded-full ${isExp ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-600'} flex items-center justify-center text-sm mr-3">${getCategoryIcon(t.category)}</div><div><div class="font-bold text-gray-700 text-sm">${t.category} <span class="text-xs text-gray-400 font-normal">/ ${t.subCategory||'-'}</span></div><div class="text-[10px] text-gray-400">${d.getMonth()+1}/${d.getDate()} Â· ${t.note || '-'}</div></div></div><div class="font-bold text-sm ${isExp ? 'text-gray-800' : 'text-green-600'}">${isExp ? '-' : '+'}$${Math.round(t.amount).toLocaleString()}</div></div>`;
                });
            });
        }

        function updateHomeUI() {
            let inc=0, exp=0, curCredit=0;
            transactions.forEach(t => { const amt = parseFloat(t.amount); if (t.type === 'income') inc += amt; else { exp += amt; if (['credit', 'linepay'].includes(t.payment)) curCredit += amt; } });
            const bal = Math.round(inc - exp);
            document.getElementById('balanceDisplay').innerText = `$${bal.toLocaleString()}`; document.getElementById('incomeDisplay').innerText = inc.toLocaleString(); document.getElementById('expenseDisplay').innerText = exp.toLocaleString();
            const card = document.getElementById('statusCard'); const ratio = inc > 0 ? (bal / inc) : 0;
            card.className = `rounded-3xl p-6 text-white shadow-xl relative overflow-hidden transition-all duration-500 ${ratio > 0.3 ? 'card-green' : (ratio > 0 ? 'card-yellow' : 'card-red')}`;
            updateDebtUI(curCredit);
        }

        let futureDebt = 0;
        function monitorFutureDebt(startStr) { db.collection("transactions").where("date", ">=", startStr).onSnapshot(s => { futureDebt = 0; s.forEach(d => { if(['credit','linepay'].includes(d.data().payment)) futureDebt += parseFloat(d.data().amount); }); updateDebtUI(parseFloat(document.getElementById('currentCreditBigDisplay').innerText.replace(/[$,]/g,''))||0); }); }
        function updateDebtUI(current) {
            const mLimit = appSettings.monthlyLimit || 50000, tLimit = appSettings.creditLimit || 200000;
            document.getElementById('currentCreditBigDisplay').innerText = `$${Math.round(current).toLocaleString()}`; document.getElementById('monthlyLimitDisplay').innerText = `$${mLimit.toLocaleString()}`; document.getElementById('monthlyRemainingDisplay').innerText = `$${Math.round(mLimit - current).toLocaleString()}`; document.getElementById('futureDebtDisplay').innerText = `$${Math.round(futureDebt).toLocaleString()}`;
            const totalUsed = current + futureDebt;
            const curP = Math.min((current/tLimit)*100, 100), futP = Math.min((futureDebt/tLimit)*100, 100-curP);
            document.getElementById('currentCreditBar').style.width = `${curP}%`; document.getElementById('futureDebtBar').style.width = `${futP}%`; document.getElementById('totalDebtLabel').innerText = `${Math.round((totalUsed/tLimit)*100)}%`;
            const card = document.getElementById('debtCard'), usageRatio = current / mLimit;
            card.className = "rounded-3xl p-6 text-white shadow-xl relative overflow-hidden transition-all duration-500";
            if (usageRatio > 0.8) card.classList.add('card-red'); else if (usageRatio > 0.5) card.classList.add('card-yellow'); else card.classList.add('card-blue');
        }

        function initCategoryFilter() { const sel = document.getElementById('categoryFilter'); sel.innerHTML = '<option value="all">ğŸ“ å…¨éƒ¨é¡åˆ¥</option>'; Object.keys(categories).forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`); }
        
        function renderHistory() {
            const list = document.getElementById('transactionList'), filter = document.getElementById('categoryFilter').value; list.innerHTML = '';
            let filteredTrans = transactions; if(filter !== 'all') filteredTrans = transactions.filter(t => t.category === filter);
            let subTotal = 0; const pieData = {};
            
            filteredTrans.forEach(t => { 
                const amt = parseFloat(t.amount); 
                if(t.type === 'expense') { subTotal += amt; pieData[t.category] = (pieData[t.category] || 0) + amt; } 
                const d = new Date(t.date), isExp = t.type === 'expense'; 
                
                list.innerHTML += `
                <div class="swipe-item-container" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
                    <div class="swipe-actions">
                        <div class="swipe-btn btn-edit" onclick="editTransaction('${t.id}')"><i class="fas fa-pen"></i></div>
                        <div class="swipe-btn btn-del" onclick="deleteTransaction('${t.id}')"><i class="fas fa-trash"></i></div>
                    </div>
                    <div class="swipe-content p-4 flex justify-between items-center h-full">
                        <div class="flex items-center w-full">
                            <div class="w-10 h-10 rounded-full ${isExp?'bg-red-50 text-red-500':'bg-green-50 text-green-600'} flex items-center justify-center text-lg mr-3 shadow-sm border border-gray-100 flex-shrink-0">
                                ${getCategoryIcon(t.category)}
                            </div>
                            <div class="flex-1 min-w-0 mr-2">
                                <div class="font-bold text-gray-800 text-base truncate">${t.category} <span class="text-sm text-gray-400 font-normal">/ ${t.subCategory || ''}</span></div>
                                <div class="text-sm text-gray-400 mt-0.5 truncate">${d.getMonth()+1}/${d.getDate()} Â· ${t.note || 'ç„¡å‚™è¨»'} ${t.installment>1 ? `(${t.installment}æœŸ)`:''}</div>
                            </div>
                            <div class="flex flex-col items-end">
                                <div class="font-bold text-lg ${isExp?'text-gray-800':'text-green-600'}">${isExp?'-':'+'}$${Math.round(t.amount).toLocaleString()}</div>
                                <button onclick="toggleActionMenu(event, this)" class="text-gray-300 hover:text-gray-500 p-2 -mr-2 mt-[-4px] transition"><i class="fas fa-ellipsis-v"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`; 
            });
            if(filteredTrans.length === 0) list.innerHTML = '<div class="text-center text-gray-400 mt-10 text-sm">ç„¡ç¬¦åˆè³‡æ–™</div>';
            document.getElementById('filterTotalDisplay').innerText = `$${Math.round(subTotal).toLocaleString()}`; renderMonthPie(pieData);
        }

        function toggleActionMenu(event, btn) {
            event.stopPropagation();
            const container = btn.closest('.swipe-item-container');
            container.classList.toggle('swiped');
            if(container.classList.contains('swiped')) {
                document.querySelectorAll('.swipe-item-container.swiped').forEach(el => {
                    if(el !== container) el.classList.remove('swiped');
                });
            }
        }

        function renderMonthPie(data) {
            const ctx = document.getElementById('monthPieChart').getContext('2d'); const entries = Object.entries(data).sort((a,b)=>b[1]-a[1]); const hasData = entries.length > 0;
            document.getElementById('monthPieEmpty').classList.toggle('hidden', hasData); if(monthPieChart) monthPieChart.destroy();
            const detailList = document.getElementById('categoryDetailList'); detailList.innerHTML = '';
            let total = entries.reduce((acc, curr) => acc + curr[1], 0); if(!hasData) return;
            monthPieChart = new Chart(ctx, { type: 'doughnut', data: { labels: entries.map(x=>x[0]), datasets: [{ data: entries.map(x=>x[1]), backgroundColor: ['#10B981','#3B82F6','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1','#14B8A6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, layout: { padding: 0 } } });
            entries.forEach(([cat, val], idx) => { const pct = ((val/total)*100).toFixed(0); const color = ['#10B981','#3B82F6','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1','#14B8A6'][idx % 8]; detailList.innerHTML += `<div class="flex items-center justify-between text-xs py-1 border-b border-gray-50 last:border-0"><div class="flex items-center truncate"><div class="w-2 h-2 rounded-full mr-2 flex-shrink-0" style="background-color: ${color}"></div><span class="text-gray-600 truncate">${cat}</span></div><div class="flex items-center space-x-2 flex-shrink-0"><span class="font-bold text-gray-700">$${Math.round(val).toLocaleString()}</span><span class="text-gray-400 w-6 text-right">${pct}%</span></div></div>`; });
        }

        let xDown = null, yDown = null;
        function handleTouchStart(evt) { xDown = evt.touches[0].clientX; yDown = evt.touches[0].clientY; document.querySelectorAll('.swiped').forEach(el => { if(el !== evt.currentTarget) el.classList.remove('swiped'); }); }
        function handleTouchMove(evt) { if (!xDown || !yDown) return; let xDiff = xDown - evt.touches[0].clientX, yDiff = yDown - evt.touches[0].clientY; if (Math.abs(xDiff) > Math.abs(yDiff)) { if (xDiff > 0) evt.currentTarget.classList.add('swiped'); else evt.currentTarget.classList.remove('swiped'); } }
        function handleTouchEnd(evt) { xDown = null; yDown = null; }
        
        function loadAnnualData() {
            document.getElementById('currentYearLabel').innerText = currentViewYear;
            const start = new Date(currentViewYear, 0, 1).toISOString(); const end = new Date(currentViewYear, 11, 31, 23, 59, 59).toISOString();
            db.collection("transactions").where("date", ">=", start).where("date", "<=", end).where("type", "==", "expense").orderBy("date", "asc").get().then(snap => { allAnnualData = []; snap.forEach(d => { if(new Date(d.data().date).getFullYear() === currentViewYear) allAnnualData.push(d.data()); }); generateAnalysis(); const sel = document.getElementById('annualCatFilter'); sel.innerHTML = '<option value="all">ğŸ“Š å…¨éƒ¨é …ç›® (ç¸½è¨ˆ)</option>'; Object.keys(categories).forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`); renderAnnualDetails(); });
        }
        function generateAnalysis() {
            const monthlySum = Array(12).fill(0), catSum = {}; let total = 0; const nowMonth = new Date().getMonth();
            allAnnualData.forEach(t => { const m = new Date(t.date).getMonth(); const amt = parseFloat(t.amount); monthlySum[m] += amt; total += amt; catSum[t.category] = (catSum[t.category]||0) + amt; });
            document.getElementById('yearTotalVal').innerText = `$${Math.round(total).toLocaleString()}`;
            const passedMonths = (currentViewYear < new Date().getFullYear()) ? 12 : nowMonth + 1;
            let passedTotal = 0; for(let i=0;i<passedMonths;i++) passedTotal += monthlySum[i];
            document.getElementById('avgYearVal').innerText = `$${Math.round(passedTotal/passedMonths).toLocaleString()}`;
            const trendData = monthlySum.map((v, i) => (currentViewYear === new Date().getFullYear() && i > nowMonth) ? 0 : v);
            renderTrendChart(trendData); renderYearPie(catSum);
        }
        async function calculateMoM() {
            const now = new Date(); const y = now.getFullYear(), m = now.getMonth(); const startThis = new Date(y, m, 1), endThis = new Date(y, m+1, 1), startLast = new Date(y, m-1, 1), endLast = new Date(y, m, 1);
            const [thisSnap, lastSnap] = await Promise.all([ db.collection("transactions").where("date", ">=", startThis.toISOString()).where("date", "<", endThis.toISOString()).where("type", "==", "expense").get(), db.collection("transactions").where("date", ">=", startLast.toISOString()).where("date", "<", endLast.toISOString()).where("type", "==", "expense").get() ]);
            let thisTotal = 0, lastTotal = 0; thisSnap.forEach(d => thisTotal += parseFloat(d.data().amount)); lastSnap.forEach(d => lastTotal += parseFloat(d.data().amount));
            const diff = thisTotal - lastTotal; const elDiff = document.getElementById('momDiffDisplay'), elText = document.getElementById('momTextDisplay');
            if(lastTotal === 0) { elDiff.innerText = `$${Math.round(thisTotal).toLocaleString()}`; elDiff.className = "text-3xl font-bold text-gray-800"; elText.innerText = "ä¸Šæœˆç„¡è³‡æ–™"; } else { const pct = Math.round((Math.abs(diff)/lastTotal)*100); if(diff > 0) { elDiff.innerText = `+${Math.round(diff).toLocaleString()}`; elDiff.className = "text-3xl font-bold text-red-500"; elText.innerText = `æ¯”ä¸Šæœˆå¤š ${pct}%`; elText.className = "text-xs text-red-400 mt-1 font-bold"; } else { elDiff.innerText = `${Math.round(diff).toLocaleString()}`; elDiff.className = "text-3xl font-bold text-green-500"; elText.innerText = `æ¯”ä¸Šæœˆå°‘ ${pct}%`; elText.className = "text-xs text-green-500 mt-1 font-bold"; } }
            document.getElementById('lastMonthTotalDisplay').innerText = `$${Math.round(lastTotal).toLocaleString()}`;
        }
        function getCategoryIcon(c) { const map = {'é£²é£Ÿ':'ğŸ”','äº¤é€š':'ğŸš—','å¨›æ¨‚':'ğŸ®','è³¼ç‰©':'ğŸ›ï¸','å±…ä½':'ğŸ ','é†«ç™‚':'ğŸ’Š','å­å¥³':'ğŸ‘¶','æŠ•è³‡':'ğŸ“ˆ','ç¤¾äº¤':'ğŸ§§','ä¿éšª':'ğŸ›¡ï¸','å…¶ä»–':'ğŸ“'}; if(c === 'æ·é‹' || c === 'å…¬è»Š') return 'ğŸšŒ'; return map[c] || 'ğŸ·ï¸'; }
        
        function renderAnnualDetails() {
            const filter = document.getElementById('annualCatFilter').value, list = document.getElementById('annualDetailsList'); list.innerHTML = ''; let data = [];
            if (filter === 'all') { const catSum = {}; allAnnualData.forEach(t => { catSum[t.category] = (catSum[t.category] || 0) + parseFloat(t.amount); }); Object.entries(catSum).forEach(([k, v]) => { data.push({ label: k, value: v, isCat: true }); }); } else { allAnnualData.filter(t => t.category === filter).forEach(t => { const d = new Date(t.date); const dStr = `${d.getMonth()+1}/${d.getDate()}`; data.push({ label: `${dStr} - ${t.subCategory || t.category}`, value: parseFloat(t.amount), note: t.note, dateObj: d }); }); }
            if (annualSortMode === 'amount') { data.sort((a, b) => b.value - a.value); } else { if(filter !== 'all') data.sort((a, b) => b.dateObj - a.dateObj); }
            data.forEach((item, idx) => { const color = ['#10B981','#3B82F6','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1','#14B8A6'][idx % 8]; const bg = filter === 'all' ? color : '#9CA3AF'; list.innerHTML += `<div class="flex items-center justify-between text-xs py-2 border-b border-gray-50 last:border-0 hover:bg-gray-50 px-1"><div class="flex items-center w-2/3"><div class="w-2 h-2 rounded-full mr-2 flex-shrink-0" style="background-color: ${bg}"></div><div class="flex flex-col"><span class="text-gray-700 font-medium truncate">${item.label}</span>${item.note ? `<span class="text-[10px] text-gray-400 truncate">${item.note}</span>` : ''}</div></div><div class="font-bold text-gray-600">$${Math.round(item.value).toLocaleString()}</div></div>`; });
            if(data.length === 0) list.innerHTML = '<div class="text-center text-gray-300 py-4">ç„¡è³‡æ–™</div>';
        }
        function toggleAnnualSort() { annualSortMode = (annualSortMode === 'amount') ? 'date' : 'amount'; document.getElementById('sortLabel').innerText = (annualSortMode === 'amount') ? 'é‡‘é¡' : 'æ—¥æœŸ'; renderAnnualDetails(); }
        function renderTrendChart(data) { const ctx = document.getElementById('trendChart').getContext('2d'); if(trendChart) trendChart.destroy(); trendChart = new Chart(ctx, { type: 'line', data: { labels: Array.from({length:12},(_,i)=>`${i+1}æœˆ`), datasets: [{ label: 'æ”¯å‡º', data: data, borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3, pointRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: {grid:{display:false}}, y: {display:false} } } }); }
        function renderYearPie(data) { const ctx = document.getElementById('yearPieChart').getContext('2d'); const entries = Object.entries(data).sort((a,b)=>b[1]-a[1]); if(yearPieChart) yearPieChart.destroy(); yearPieChart = new Chart(ctx, { type: 'doughnut', data: { labels: entries.map(x=>x[0]), datasets: [{ data: entries.map(x=>x[1]), backgroundColor: ['#10B981','#3B82F6','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1','#14B8A6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position: 'right', labels:{boxWidth:12}} } } }); }

        function openAddModal() { 
            document.getElementById('addModal').classList.remove('hidden'); 
            const n=new Date(); 
            document.getElementById('dateInput').value=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
            
            document.getElementById('amountInput').value = '';
            document.getElementById('noteInput').value = '';
            document.getElementById('paymentInput').value = 'cash'; 
            
            // é‡ç½®åˆ†æœŸç›¸é—œæ¬„ä½
            document.getElementById('installmentSelect').value = '1'; 
            document.getElementById('installmentCustomInput').value = '';
            handleInstallmentChange(); 

            toggleInstallment(); 
            updateCategories(); 
        }
        
        function closeAddModal() { 
            document.getElementById('addModal').classList.add('hidden'); 
            editingId = null; 
            editingGroupId = null; // é‡ç½®
        }
        
        function renderQuickTags() {
            const combinedVal = document.getElementById('combinedCategoryInput').value;
            const subCategory = combinedVal.split(',')[1];
            const container = document.getElementById('quickTagContainer');
            container.innerHTML = '';

            if (categoryTags[subCategory]) {
                categoryTags[subCategory].forEach(tag => {
                    const btn = document.createElement('button');
                    btn.className = 'tag-btn';
                    btn.innerText = tag;
                    btn.onclick = (e) => {
                        e.preventDefault(); 
                        const noteInput = document.getElementById('noteInput');
                        const currentVal = noteInput.value.trim();
                        if (currentVal) {
                            noteInput.value = currentVal + ' ' + tag;
                        } else {
                            noteInput.value = tag;
                        }
                    };
                    container.appendChild(btn);
                });
            }
        }

        // è™•ç†åˆ†æœŸä¸‹æ‹‰é¸å–®è®ŠåŒ–
        function handleInstallmentChange() {
            const select = document.getElementById('installmentSelect');
            const customInput = document.getElementById('installmentCustomInput');
            if (select.value === 'custom') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        }

        function toggleInstallment() { 
            document.getElementById('installmentBlock').classList.toggle('hidden', !(document.getElementById('paymentInput').value==='credit')); 
        }

        async function submitForm() {
            try {
                const amt = parseFloat(document.getElementById('amountInput').value);
                const dateVal = document.getElementById('dateInput').value;
                if(!amt || !dateVal) return alert("è«‹è¼¸å…¥é‡‘é¡èˆ‡æ—¥æœŸ");

                const type = document.getElementById('typeInput').value;
                const catParts = document.getElementById('combinedCategoryInput').value.split(',');
                const payment = document.getElementById('paymentInput').value;
                const note = document.getElementById('noteInput').value;
                const cat = catParts[0]; 
                const sub = catParts[1] || ''; 
                
                // å–å¾—åˆ†æœŸæœŸæ•¸ (è‡ªè¨‚æˆ–é¸å–®)
                let inst = 1;
                if (type === 'expense' && payment === 'credit') {
                    const selectVal = document.getElementById('installmentSelect').value;
                    if (selectVal === 'custom') {
                        inst = parseInt(document.getElementById('installmentCustomInput').value);
                        if (!inst || inst < 1) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„è‡ªè¨‚æœŸæ•¸");
                    } else {
                        inst = parseInt(selectVal);
                    }
                }
                
                const batch = db.batch();
                const grpId = Date.now().toString(); 
                
                const baseDate = new Date(dateVal); 
                const now = new Date(); 
                baseDate.setHours(now.getHours(), now.getMinutes());
                const createdAt = new Date().toISOString();

                // åˆªé™¤èˆŠè³‡æ–™é‚è¼¯ (å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼)
                if (editingGroupId) {
                    const oldGroup = await db.collection("transactions").where("groupId", "==", editingGroupId).get();
                    oldGroup.forEach(doc => batch.delete(doc.ref));
                } else if (editingId) {
                    batch.delete(db.collection("transactions").doc(editingId));
                }

                // å»ºç«‹æ–°è³‡æ–™é‚è¼¯
                if (inst > 1) { 
                    const per = Math.round(amt / inst); 
                    for (let i = 0; i < inst; i++) { 
                        const ref = db.collection("transactions").doc();
                        
                        // [V6.1 æœ€çµ‚é‚è¼¯] 
                        // ç¬¬1æœŸï¼šç¶­æŒä½¿ç”¨è€…è¼¸å…¥çš„ç¢ºåˆ‡æ—¥æœŸ
                        // ç¬¬2æœŸä»¥å¾Œï¼šå¾€å¾Œæ¨æœˆï¼Œå¼·åˆ¶è¨­ç‚º1è™Ÿ
                        let d;
                        if (i === 0) {
                            d = new Date(baseDate); 
                        } else {
                            d = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, 1);
                        }
                        
                        batch.set(ref, {
                            amount: per,
                            type,
                            category: cat,
                            subCategory: sub,
                            payment,
                            installment: inst,
                            note: `${note} (${i + 1}/${inst})`, 
                            date: d.toISOString(),
                            groupId: grpId, 
                            createdAt: createdAt
                        }); 
                    }
                } else {
                    const ref = db.collection("transactions").doc();
                    batch.set(ref, {
                        amount: amt,
                        type,
                        category: cat,
                        subCategory: sub,
                        payment,
                        installment: 1,
                        note,
                        date: baseDate.toISOString(),
                        createdAt: createdAt
                    });
                }
                
                await batch.commit(); 
                closeAddModal();
                showSuccessToast();
            } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); console.error(e); }
        }

        // ä¿®æ”¹åˆªé™¤é‚è¼¯ï¼šæ”¯æ´æ•´çµ„åˆªé™¤
        async function deleteTransaction(id) {
            try {
                const doc = await db.collection("transactions").doc(id).get();
                const data = doc.data();

                if (data.groupId) {
                    if (confirm(`é€™æ˜¯ä¸€ç­†åˆ†æœŸä»˜æ¬¾ç´€éŒ„ (${data.installment}æœŸ)ã€‚\nè¦åˆªé™¤ã€Œæ•´çµ„ã€æ‰€æœ‰æœŸæ•¸å—ï¼Ÿ\n(æŒ‰ã€Œå–æ¶ˆã€å‰‡åªåˆªé™¤é€™ä¸€ç­†)`)) {
                        const snapshot = await db.collection("transactions").where("groupId", "==", data.groupId).get();
                        const batch = db.batch();
                        snapshot.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        showSuccessToast();
                        return;
                    }
                }
                
                if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ")) {
                     await db.collection("transactions").doc(id).delete();
                }
            } catch (e) { console.error(e); alert("åˆªé™¤å¤±æ•—"); }
        }
        
        // ä¿®æ”¹ç·¨è¼¯é‚è¼¯ï¼šæº¯æºæŸ¥æ‰¾ç¬¬ä¸€æœŸæ—¥æœŸ (Async)
        async function editTransaction(id) {
            // å…ˆå¾æœ¬åœ°åˆ—è¡¨æ‰¾åŸºæœ¬è³‡æ–™
            const t = transactions.find(x => x.id === id); 
            if(!t) return; 

            editingId = id;
            editingGroupId = t.groupId || null;

            document.getElementById('addModal').classList.remove('hidden'); 
            
            // é è¨­æ—¥æœŸç‚ºç•¶ä¸‹é»é¸é€™ç­†çš„æ—¥æœŸ
            let targetDate = new Date(t.date);

            // å¦‚æœæ˜¯åˆ†æœŸä»˜æ¬¾ï¼Œéœ€è¦ã€Œæº¯æºã€æ‰¾ç¬¬ä¸€æœŸ
            if (editingGroupId && t.installment > 1) {
                const totalAmount = t.amount * t.installment;
                document.getElementById('amountInput').value = totalAmount;
                
                // [V6.1 æ–°å¢] å»è³‡æ–™åº«æ‰¾é€™çµ„ ID çš„ç¬¬ä¸€ç­†è³‡æ–™ (order by date asc limit 1)
                try {
                    const snap = await db.collection("transactions")
                        .where("groupId", "==", editingGroupId)
                        .orderBy("date", "asc")
                        .limit(1)
                        .get();
                        
                    if (!snap.empty) {
                        const firstDoc = snap.docs[0].data();
                        targetDate = new Date(firstDoc.date); // æŠ“åˆ°çœŸæ­£çš„ç¬¬ä¸€æœŸæ—¥æœŸäº†ï¼
                    }
                } catch(e) {
                    console.error("æº¯æºå¤±æ•—", e);
                }

                alert(`æ³¨æ„ï¼šæ‚¨æ­£åœ¨ç·¨è¼¯ä¸€ç­† ${t.installment} æœŸçš„åˆ†æœŸä»˜æ¬¾ã€‚\né‡‘é¡å·²é‚„åŸç‚ºç¸½é¡ã€‚\næ—¥æœŸå·²è‡ªå‹•å°é½Šè‡³ã€Œç¬¬ 1 æœŸã€çš„åŸå§‹æ—¥æœŸã€‚`);
            } else {
                document.getElementById('amountInput').value = t.amount; 
            }

            document.getElementById('noteInput').value = t.note.replace(/\s\(\d+\/\d+\)$/,''); 
            document.getElementById('typeInput').value = t.type;
            
            updateCategories();
            const sel = document.getElementById('combinedCategoryInput'); 
            for(let i=0; i<sel.options.length; i++) {
                if(sel.options[i].value.includes(t.subCategory)) sel.selectedIndex=i;
            }
            
            renderQuickTags();

            document.getElementById('paymentInput').value = t.payment || 'cash';
            
            // é‚„åŸåˆ†æœŸè¨­å®š UI
            if(t.payment === 'credit') {
                const standard = ['1', '3', '6', '12'];
                const instStr = t.installment.toString();
                
                if (standard.includes(instStr)) {
                    document.getElementById('installmentSelect').value = instStr;
                    document.getElementById('installmentCustomInput').classList.add('hidden');
                } else {
                    document.getElementById('installmentSelect').value = 'custom';
                    document.getElementById('installmentCustomInput').value = t.installment;
                    document.getElementById('installmentCustomInput').classList.remove('hidden');
                }
            } else {
                document.getElementById('installmentSelect').value = '1';
                document.getElementById('installmentCustomInput').classList.add('hidden');
            }
            
            toggleInstallment();
            
            // å¡«å…¥æº¯æºå¾Œçš„æ—¥æœŸ
            document.getElementById('dateInput').value = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
        }
        
        // è£œå›éºå¤±çš„ updateCategories å‡½å¼
        function updateCategories() {
            const s = document.getElementById('combinedCategoryInput');
            const t = document.getElementById('typeInput').value;
            const f = document.getElementById('expenseOnlyFields'); 
            
            s.innerHTML = '';
            
            if(t === 'income') { 
                f.classList.add('hidden'); 
                s.innerHTML = '<option value="è–ªè³‡,æœ¬è–ª">ğŸ’° è–ªè³‡</option><option value="çé‡‘,ç¸¾æ•ˆ">ğŸ§§ çé‡‘</option>'; 
            } else { 
                f.classList.remove('hidden'); 
                Object.entries(categories).forEach(([k,v])=>{
                    const g = document.createElement('optgroup');
                    const icon = getCategoryIcon(k); 
                    g.label = `${icon} ${k}`;        
                    v.forEach(i => g.innerHTML += `<option value="${k},${i}">${i}</option>`);
                    s.appendChild(g);
                }); 
            }
            // æ›´æ–°é¡åˆ¥å¾Œï¼Œä¹Ÿè¦é‡åˆ·æ¨™ç±¤ï¼Œç¢ºä¿ç•«é¢åŒæ­¥
            renderQuickTags();
        }

        function showSuccessToast() {
            const toast = document.getElementById('successToast');
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('hidden'); }, 1500);
        }

        function saveSettings() { appSettings.creditLimit = parseInt(document.getElementById('creditLimitInput').value); appSettings.monthlyLimit = parseInt(document.getElementById('monthlyLimitInput').value); localStorage.setItem('appSettings', JSON.stringify(appSettings)); loadData(); alert("è¨­å®šå·²å„²å­˜"); }
        async function exportToCSV() { if(!confirm("åŒ¯å‡º?")) return; const s = await db.collection("transactions").orderBy("date","desc").get(); let c = "\uFEFFDate,Type,Cat,Sub,Amt,Note\n"; s.forEach(d=>{const t=d.data();c+=`${new Date(t.date).toLocaleDateString()},${t.type},${t.category},${t.subCategory},${t.amount},${t.note}\n`}); const l = document.createElement("a"); l.href=URL.createObjectURL(new Blob([c],{type:'text/csv'})); l.download="backup.csv"; l.click(); }
    </script>
</body>
</html>
